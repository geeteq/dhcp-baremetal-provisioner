<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Baremetal Services â€” AI Assistant</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ---- Header ---- */
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 0 24px;
      height: 60px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,.25);
      z-index: 10;
    }
    .logo {
      width: 32px; height: 32px;
      background: rgba(255,255,255,.2);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }
    header h1 { font-size: 18px; font-weight: 600; letter-spacing: .3px; }
    header p  { font-size: 13px; opacity: .75; margin-left: auto; }

    /* ---- Body layout ---- */
    .body { display: flex; flex: 1; overflow: hidden; }

    /* ---- Sidebar ---- */
    .sidebar {
      width: 280px; flex-shrink: 0;
      background: #fff;
      border-right: 1px solid #e2e8f0;
      display: flex; flex-direction: column; overflow: hidden;
    }
    .sidebar-header { padding: 16px; border-bottom: 1px solid #e2e8f0; }
    .sidebar-header h2 {
      font-size: 12px; font-weight: 600;
      text-transform: uppercase; letter-spacing: .8px; color: #64748b;
    }
    .sidebar-stats { margin-top: 8px; display: flex; gap: 12px; }
    .stat {
      flex: 1;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px; padding: 10px 12px; color: #fff;
    }
    .stat-value { font-size: 22px; font-weight: 700; line-height: 1; }
    .stat-label { font-size: 11px; opacity: .8; margin-top: 3px; }
    .site-list { flex: 1; overflow-y: auto; padding: 8px; }
    .site-btn {
      width: 100%; display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border: none; border-radius: 8px;
      background: transparent; cursor: pointer; text-align: left;
      transition: background .15s; margin-bottom: 4px;
    }
    .site-btn:hover { background: #f1f5f9; }
    .site-btn.active {
      background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%);
      outline: 2px solid #667eea44;
    }
    .site-icon {
      width: 32px; height: 32px; border-radius: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex; align-items: center; justify-content: center;
      font-size: 15px; flex-shrink: 0;
    }
    .site-info { flex: 1; min-width: 0; }
    .site-name {
      font-size: 13px; font-weight: 500; color: #1e293b;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .site-sub { font-size: 11px; color: #94a3b8; margin-top: 1px; }
    .badge {
      background: #667eea; color: #fff;
      font-size: 11px; font-weight: 600;
      padding: 2px 7px; border-radius: 10px; flex-shrink: 0;
    }
    .sidebar-loading { padding: 24px; text-align: center; color: #94a3b8; font-size: 13px; }

    /* ---- Chat area ---- */
    .chat-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .messages {
      flex: 1; overflow-y: auto; padding: 24px;
      display: flex; flex-direction: column; gap: 16px;
    }

    /* ---- Empty state (map welcome) ---- */
    .empty-state {
      display: flex; flex-direction: column; gap: 16px;
    }

    /* Welcome bar */
    .welcome-bar { display: flex; align-items: center; gap: 14px; }
    .welcome-icon-wrap {
      width: 48px; height: 48px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 14px;
      display: flex; align-items: center; justify-content: center;
      font-size: 24px; flex-shrink: 0;
    }
    .welcome-bar h2 { font-size: 17px; font-weight: 600; color: #1e293b; }
    .welcome-bar p  { font-size: 13px; color: #64748b; margin-top: 3px; }

    /* Map */
    .map-wrapper {
      height: 280px; border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 16px rgba(0,0,0,.12), 0 0 0 1px rgba(0,0,0,.05);
      flex-shrink: 0;
    }
    #dc-map { height: 100%; width: 100%; }

    /* Leaflet popup overrides */
    .leaflet-popup-content-wrapper {
      border-radius: 10px !important;
      box-shadow: 0 4px 20px rgba(0,0,0,.15) !important;
      border: 1px solid #e2e8f0 !important;
      padding: 0 !important;
    }
    .leaflet-popup-content { margin: 12px 14px !important; min-width: 150px; }
    .leaflet-popup-tip { display: none !important; }
    .leaflet-popup-tip-container { display: none !important; }
    .leaflet-container { font-family: inherit; }

    .dc-popup strong  { font-size: 13px; font-weight: 600; color: #1e293b; display: block; }
    .dc-popup .popup-city  { font-size: 11px; color: #64748b; display: block; margin-top: 3px; }
    .dc-popup .popup-count { font-size: 12px; color: #667eea; font-weight: 600; display: block; margin-top: 8px; }
    .dc-popup .popup-count.zero { color: #94a3b8; }
    .popup-filter-btn {
      display: block; width: 100%; margin-top: 8px;
      padding: 6px 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff; border: none; border-radius: 6px;
      font-size: 11px; font-weight: 500; cursor: pointer;
      font-family: inherit; text-align: center; letter-spacing: .2px;
    }
    .popup-filter-btn:hover { opacity: .9; }

    /* Map pin markers */
    .map-pin-outer {
      position: relative; width: 40px; height: 40px; cursor: pointer;
    }
    .map-pin-pulse {
      position: absolute; inset: 0; border-radius: 50%;
      border: 2px solid #667eea;
      animation: map-pulse 2.5s ease-out infinite;
    }
    @keyframes map-pulse {
      0%   { transform: scale(1);   opacity: .7; }
      100% { transform: scale(2);   opacity: 0;  }
    }
    .map-pin-dot {
      position: absolute; inset: 5px; border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: 2.5px solid #fff;
      box-shadow: 0 2px 10px rgba(102,126,234,.6);
      display: flex; align-items: center; justify-content: center;
    }
    .map-pin-count {
      color: #fff; font-size: 8px; font-weight: 800;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1;
    }

    /* DC pills bar */
    .dc-pills-bar { display: flex; gap: 8px; flex-wrap: wrap; }
    .dc-pill {
      display: flex; align-items: center; gap: 6px;
      background: #fff; border: 1px solid #e2e8f0;
      border-radius: 20px; padding: 6px 12px;
      font-size: 12px; color: #475569;
      cursor: pointer; transition: all .15s; font-family: inherit;
    }
    .dc-pill:hover { border-color: #667eea; color: #667eea; background: #667eea0d; }
    .dc-pill .pill-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      flex-shrink: 0;
    }
    .dc-pill .pill-count {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff; font-size: 10px; font-weight: 700;
      padding: 1px 6px; border-radius: 8px;
    }

    /* Starter questions */
    .starters-label {
      font-size: 11px; font-weight: 600;
      text-transform: uppercase; letter-spacing: .7px; color: #94a3b8;
      margin-bottom: 8px;
    }
    .starters { display: flex; flex-wrap: wrap; gap: 8px; }
    .starter-btn {
      border: 1px solid #e2e8f0; background: #fff;
      border-radius: 20px; padding: 8px 16px;
      font-size: 13px; cursor: pointer; transition: all .15s; color: #475569;
    }
    .starter-btn:hover { border-color: #667eea; color: #667eea; background: #667eea0d; }

    /* ---- Message bubbles ---- */
    .msg { display: flex; gap: 10px; max-width: 780px; }
    .msg.user  { align-self: flex-end; flex-direction: row-reverse; }
    .msg.ai    { align-self: flex-start; }
    .avatar {
      width: 32px; height: 32px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px; flex-shrink: 0;
    }
    .msg.user .avatar { background: #667eea; color: #fff; }
    .msg.ai   .avatar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
    .bubble {
      padding: 12px 16px; border-radius: 16px;
      font-size: 14px; line-height: 1.6; max-width: 100%;
    }
    .msg.user .bubble { background: #667eea; color: #fff; border-bottom-right-radius: 4px; }
    .msg.ai   .bubble { background: #fff; color: #1e293b; border-bottom-left-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
    .bubble h1, .bubble h2, .bubble h3 { margin: 10px 0 6px; }
    .bubble p { margin-bottom: 8px; }
    .bubble p:last-child { margin-bottom: 0; }
    .bubble ul, .bubble ol { padding-left: 20px; margin-bottom: 8px; }
    .bubble li { margin-bottom: 4px; }
    .bubble code { background: #f1f5f9; padding: 1px 5px; border-radius: 4px; font-size: 12px; font-family: 'SF Mono', Menlo, monospace; }
    .bubble pre { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; overflow-x: auto; margin-bottom: 8px; }
    .bubble pre code { background: none; padding: 0; }
    .bubble table { border-collapse: collapse; width: 100%; margin-bottom: 8px; font-size: 13px; }
    .bubble th, .bubble td { border: 1px solid #e2e8f0; padding: 6px 10px; text-align: left; }
    .bubble th { background: #f8fafc; font-weight: 600; }
    .bubble strong { font-weight: 600; }

    /* ---- Loading spinner ---- */
    .typing { display: flex; gap: 5px; padding: 14px 16px; align-items: center; }
    .dot { width: 7px; height: 7px; background: #94a3b8; border-radius: 50%; animation: bounce .9s infinite; }
    .dot:nth-child(2) { animation-delay: .15s; }
    .dot:nth-child(3) { animation-delay: .3s; }
    @keyframes bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }

    /* ---- Input bar ---- */
    .input-bar {
      padding: 16px 24px; background: #fff; border-top: 1px solid #e2e8f0;
      display: flex; gap: 10px; align-items: flex-end;
    }
    .filter-chip {
      display: flex; align-items: center; gap: 6px;
      background: #667eea15; border: 1px solid #667eea40;
      border-radius: 20px; padding: 6px 12px;
      font-size: 12px; color: #667eea; font-weight: 500;
      white-space: nowrap; flex-shrink: 0;
    }
    .filter-chip-x { cursor: pointer; font-size: 14px; line-height: 1; opacity: .6; }
    .filter-chip-x:hover { opacity: 1; }
    textarea {
      flex: 1; border: 1px solid #e2e8f0; border-radius: 12px;
      padding: 12px 16px; font-size: 14px; font-family: inherit;
      resize: none; min-height: 48px; max-height: 160px;
      outline: none; transition: border-color .15s; line-height: 1.5;
    }
    textarea:focus { border-color: #667eea; }
    textarea::placeholder { color: #94a3b8; }
    .send-btn {
      width: 44px; height: 44px; border-radius: 12px; border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff; font-size: 18px; cursor: pointer; flex-shrink: 0;
      transition: opacity .15s; display: flex; align-items: center; justify-content: center;
    }
    .send-btn:disabled { opacity: .4; cursor: not-allowed; }
    .send-btn:not(:disabled):hover { opacity: .9; }
  </style>
</head>
<body>

<header>
  <div class="logo">&#9964;</div>
  <h1>Baremetal Services AI Assistant</h1>
  <p>Powered by live NetBox data</p>
</header>

<div class="body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>Datacenters</h2>
      <div class="sidebar-stats">
        <div class="stat">
          <div class="stat-value" id="total-ready">â€”</div>
          <div class="stat-label">Available Servers</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="total-sites">â€”</div>
          <div class="stat-label">Active Sites</div>
        </div>
      </div>
    </div>
    <div class="site-list" id="site-list">
      <div class="sidebar-loading">Loading datacentersâ€¦</div>
    </div>
  </aside>

  <!-- Chat -->
  <main class="chat-area">
    <div class="messages" id="messages">
      <div class="empty-state" id="empty-state">

        <!-- Welcome header -->
        <div class="welcome-bar">
          <div class="welcome-icon-wrap">ğŸŒ</div>
          <div>
            <h2>North America Datacenter Network</h2>
            <p id="map-subtitle">Loading datacenter statusâ€¦</p>
          </div>
        </div>

        <!-- Map -->
        <div class="map-wrapper">
          <div id="dc-map"></div>
        </div>

        <!-- DC pills -->
        <div class="dc-pills-bar" id="dc-pills-bar"></div>

        <!-- Starter questions -->
        <div>
          <div class="starters-label">Suggested questions</div>
          <div class="starters">
            <button class="starter-btn" onclick="sendStarter(this)">What servers are available right now?</button>
            <button class="starter-btn" onclick="sendStarter(this)">Which datacenters have the most capacity?</button>
            <button class="starter-btn" onclick="sendStarter(this)">Do you have HPE servers in stock?</button>
            <button class="starter-btn" onclick="sendStarter(this)">What's the delivery timeline?</button>
            <button class="starter-btn" onclick="sendStarter(this)">How much power capacity is available?</button>
            <button class="starter-btn" onclick="sendStarter(this)">What does baremetal access include?</button>
          </div>
        </div>

      </div>
    </div>

    <div class="input-bar">
      <span class="filter-chip" id="filter-chip" style="display:none">
        <span id="filter-chip-label"></span>
        <span class="filter-chip-x" onclick="clearFilter()">âœ•</span>
      </span>
      <textarea
        id="input"
        rows="1"
        placeholder="Ask about availability, capacity, server specsâ€¦"
        onkeydown="handleKey(event)"
        oninput="autoResize(this)"
      ></textarea>
      <button class="send-btn" id="send-btn" onclick="sendMessage()" title="Send">&#10148;</button>
    </div>
  </main>
</div>

<script>
  // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let messages   = [];
  let siteFilter = null;
  let loading    = false;

  // â”€â”€â”€ Datacenter coordinates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const DC_COORDS = {
    'dc-toronto':   { lat: 43.6452, lng: -79.3806,  city: 'Toronto, ON',   name: 'DC-Toronto' },
    'dc-vancouver': { lat: 49.2827, lng: -123.1207, city: 'Vancouver, BC', name: 'DC-Vancouver' },
    'dc-calgary':   { lat: 51.0447, lng: -114.0719, city: 'Calgary, AB',   name: 'DC-Calgary' },
    'dc-montreal':  { lat: 45.4972, lng: -73.5679,  city: 'MontrÃ©al, QC', name: 'DC-Montreal' },
    'dc-edmonton':  { lat: 53.5461, lng: -113.4938, city: 'Edmonton, AB',  name: 'DC-Edmonton' },
    'dc-ottawa':    { lat: 45.4215, lng: -75.6972,  city: 'Ottawa, ON',    name: 'DC-Ottawa' },
  };

  // â”€â”€â”€ Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let dcMap     = null;
  const dcPins  = {};   // slug â†’ Leaflet marker

  function initMap() {
    dcMap = L.map('dc-map', {
      center: [52, -96],
      zoom: 4,
      zoomControl: true,
      scrollWheelZoom: false,
      attributionControl: true,
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors Â© <a href="https://carto.com/attributions">CARTO</a>',
      maxZoom: 18,
    }).addTo(dcMap);

    // Add placeholder pins for all known DCs (count = null = loading)
    Object.entries(DC_COORDS).forEach(([slug, info]) => {
      addOrUpdatePin(slug, info.name, info.city, null);
    });
  }

  function makePinIcon(count) {
    const label = count === null ? 'â€¦' : (count > 999 ? '999+' : String(count));
    return L.divIcon({
      className: '',
      html: `<div class="map-pin-outer">
               <div class="map-pin-pulse"></div>
               <div class="map-pin-dot">
                 <span class="map-pin-count">${label}</span>
               </div>
             </div>`,
      iconSize:    [40, 40],
      iconAnchor:  [20, 20],
      popupAnchor: [0, -24],
    });
  }

  function makePopupHtml(slug, name, city, count) {
    const countHtml = count === null
      ? '<span class="popup-count zero">Loadingâ€¦</span>'
      : count > 0
        ? `<span class="popup-count">${count} servers available</span>`
        : '<span class="popup-count zero">No servers available</span>';
    return `<div class="dc-popup">
      <strong>${name}</strong>
      <span class="popup-city">ğŸ“ ${city}</span>
      ${countHtml}
      <button class="popup-filter-btn" onclick="selectSiteFromMap('${slug}','${name}')">
        Filter to this DC &rarr;
      </button>
    </div>`;
  }

  function addOrUpdatePin(slug, name, city, count) {
    if (!dcMap) return;
    const info = DC_COORDS[slug];
    if (!info) return;

    if (dcPins[slug]) {
      dcPins[slug].setIcon(makePinIcon(count));
      dcPins[slug].setPopupContent(makePopupHtml(slug, name, city, count));
    } else {
      const marker = L.marker([info.lat, info.lng], { icon: makePinIcon(count) })
        .bindPopup(makePopupHtml(slug, name, city, count), { maxWidth: 210, closeButton: false })
        .addTo(dcMap);
      dcPins[slug] = marker;
    }
  }

  // Called from inside Leaflet popup button (must be global)
  function selectSiteFromMap(slug, name) {
    selectSite(slug, name);
    Object.values(dcPins).forEach(m => m.closePopup());
    // Zoom to selected DC
    const info = DC_COORDS[slug];
    if (info && dcMap) dcMap.flyTo([info.lat, info.lng], 7, { duration: 1 });
  }

  function buildDcPills(allSites) {
    const bar = document.getElementById('dc-pills-bar');
    bar.innerHTML = '';
    Object.entries(DC_COORDS).forEach(([slug, info]) => {
      const siteData = allSites.find(s => s.slug === slug);
      const count    = siteData ? siteData.ready_count : 0;
      const name     = siteData ? siteData.name : info.name;

      const pill = document.createElement('button');
      pill.className   = 'dc-pill';
      pill.innerHTML   = `
        <span class="pill-dot"></span>
        <span>${name}</span>
        ${count > 0 ? `<span class="pill-count">${count}</span>` : ''}
      `;
      pill.onclick = () => {
        selectSite(siteData ? slug : null, name);
        if (dcMap && info) {
          dcMap.flyTo([info.lat, info.lng], 7, { duration: 1 });
          dcPins[slug]?.openPopup();
        }
      };
      bar.appendChild(pill);
    });
  }

  // â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadSites() {
    try {
      const res  = await fetch('/api/sites');
      const data = await res.json();

      document.getElementById('total-ready').textContent = data.total_ready ?? 'â€”';
      document.getElementById('total-sites').textContent = data.total_sites ?? 'â€”';
      document.getElementById('map-subtitle').textContent =
        `${data.total_sites} sites Â· ${data.total_ready} servers available`;

      // Sidebar buttons
      const list = document.getElementById('site-list');
      list.innerHTML = '';
      const allBtn = makeBtn('All Datacenters', null, '&#127758;', 'All sites', data.total_ready);
      list.appendChild(allBtn);
      (data.sites || []).forEach(site => {
        list.appendChild(makeBtn(site.name, site.slug, '&#127963;', `${site.ready_count} available`, site.ready_count));
      });
      if (!data.sites || data.sites.length === 0) {
        const note = document.createElement('div');
        note.className   = 'sidebar-loading';
        note.textContent = 'No sites with available servers.';
        list.appendChild(note);
      }

      // Update all map pins with live counts
      // Include all DCs â€” ones not in /api/sites (0 servers) stay at 0
      const allSites = data.sites || [];
      Object.entries(DC_COORDS).forEach(([slug, info]) => {
        const siteData = allSites.find(s => s.slug === slug);
        const count    = siteData ? siteData.ready_count : 0;
        const name     = siteData ? siteData.name : info.name;
        addOrUpdatePin(slug, name, info.city, count);
      });

      buildDcPills(allSites);

    } catch (e) {
      document.getElementById('site-list').innerHTML =
        '<div class="sidebar-loading">Could not load datacenter data.</div>';
      document.getElementById('map-subtitle').textContent = 'Could not load datacenter data.';
    }
  }

  function makeBtn(name, slug, icon, sub, count) {
    const btn = document.createElement('button');
    btn.className      = 'site-btn' + (slug === siteFilter ? ' active' : '');
    btn.dataset.slug   = slug || '';
    btn.onclick        = () => selectSite(slug, name);
    btn.innerHTML = `
      <div class="site-icon">${icon}</div>
      <div class="site-info">
        <div class="site-name">${name}</div>
        <div class="site-sub">${sub}</div>
      </div>
      ${count > 0 ? `<span class="badge">${count}</span>` : ''}
    `;
    return btn;
  }

  function selectSite(slug, name) {
    siteFilter = slug || null;
    document.querySelectorAll('.site-btn').forEach(b => {
      b.classList.toggle('active', (b.dataset.slug || null) === siteFilter);
    });
    const chip = document.getElementById('filter-chip');
    if (siteFilter) {
      document.getElementById('filter-chip-label').textContent = 'ğŸ¢ ' + name;
      chip.style.display = 'flex';
    } else {
      chip.style.display = 'none';
    }
  }

  function clearFilter() { selectSite(null, null); }

  // â”€â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function sendStarter(btn) {
    document.getElementById('input').value = btn.textContent;
    sendMessage();
  }

  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  }

  function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 160) + 'px';
  }

  async function sendMessage() {
    const input = document.getElementById('input');
    const text  = input.value.trim();
    if (!text || loading) return;

    input.value = '';
    input.style.height = '';

    document.getElementById('empty-state').style.display = 'none';
    appendMsg('user', text);
    messages.push({ role: 'user', content: text });

    const typingEl = appendTyping();
    setLoading(true);

    try {
      const res  = await fetch('/api/chat', {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify({ messages, site_filter: siteFilter }),
      });
      const data = await res.json();
      typingEl.remove();
      setLoading(false);
      appendMsg('ai', data.reply || 'Sorry, I could not get a response. Please try again.');
      messages = data.messages || messages;
    } catch (err) {
      typingEl.remove();
      setLoading(false);
      appendMsg('ai', 'Network error. Please check your connection and try again.');
    }
    scrollToBottom();
  }

  function appendMsg(role, text) {
    const container = document.getElementById('messages');
    const div    = document.createElement('div');
    div.className = `msg ${role}`;
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = role === 'ai' ? marked.parse(text) : '';
    if (role !== 'ai') bubble.textContent = text;
    div.appendChild(avatar);
    div.appendChild(bubble);
    container.appendChild(div);
    scrollToBottom();
    return div;
  }

  function appendTyping() {
    const container = document.getElementById('messages');
    const div    = document.createElement('div');
    div.className = 'msg ai';
    const avatar = document.createElement('div');
    avatar.className  = 'avatar';
    avatar.textContent = 'ğŸ¤–';
    const bubble = document.createElement('div');
    bubble.className  = 'bubble';
    bubble.innerHTML  = '<div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
    div.appendChild(avatar);
    div.appendChild(bubble);
    container.appendChild(div);
    scrollToBottom();
    return div;
  }

  function setLoading(state) {
    loading = state;
    document.getElementById('send-btn').disabled = state;
    document.getElementById('input').disabled    = state;
  }

  function scrollToBottom() {
    const c = document.getElementById('messages');
    c.scrollTop = c.scrollHeight;
  }

  // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  initMap();
  loadSites();
</script>
</body>
</html>
