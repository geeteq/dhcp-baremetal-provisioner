# ─────────────────────────────────────────────────────────────────────────────
# Kickstart: BM-Validate Live ISO
# Target: Rocky Linux 9 (RHEL9-compatible)
# Build:  livemedia-creator --ks ks.cfg --no-virt --resultdir /tmp/bm-validate-iso
#
# The resulting ISO boots directly into the validation suite and powers off
# when complete. Pass NetBox/ESB config via kernel cmdline:
#   bm.netbox_url=http://10.0.0.1:8000
#   bm.netbox_token=<token>
#   bm.callback_url=http://10.0.0.1:5000
# ─────────────────────────────────────────────────────────────────────────────

lang en_US.UTF-8
keyboard us
timezone UTC
selinux --disabled
firewall --disabled
rootpw --plaintext bmvalidate
bootloader --timeout=3

# Tell anaconda this is a live image
liveimg

# Repos — use Rocky 9 mirrors (or your local mirror)
url --url=https://dl.rockylinux.org/pub/rocky/9/BaseOS/x86_64/os/
repo --name=AppStream --baseurl=https://dl.rockylinux.org/pub/rocky/9/AppStream/x86_64/os/
repo --name=EPEL --baseurl=https://dl.fedoraproject.org/pub/epel/9/Everything/x86_64/

%packages --excludedocs --instLangs=en
# Minimal base
@^minimal-environment
kernel
grub2
grub2-efi-x64
shim
efibootmgr

# Hardware discovery
dmidecode
lshw
pciutils
usbutils
hdparm
smartmontools
nvme-cli

# Network
iproute
ethtool
dhclient
curl
bind-utils

# LLDP
lldpad
lldptools

# Memory test
memtester

# Disk I/O benchmark
fio

# Scripting
python3
python3-pip
bash
jq

# Remove unneeded
-abrt*
-avahi*
-bluez*
-cups*
-fprintd*
-plymouth
-sendmail*
-wpa_supplicant
%end

%post --erroronfail
# ── Install validation scripts ────────────────────────────────────────────────
mkdir -p /opt/bm-validate/scripts/lib

# Copy scripts from the build tree (populated by build.sh)
cp -r /tmp/bm-validate-scripts/* /opt/bm-validate/
chmod -R +x /opt/bm-validate/

# ── Install systemd service ───────────────────────────────────────────────────
cp /tmp/bm-validate-systemd/bm-validate.service /etc/systemd/system/
systemctl enable bm-validate.service

# ── Auto-login root on console (for visibility during boot) ──────────────────
mkdir -p /etc/systemd/system/getty@tty1.service.d
cat > /etc/systemd/system/getty@tty1.service.d/override.conf <<'EOF'
[Service]
ExecStart=
ExecStart=-/usr/sbin/agetty --autologin root --noclear %I $TERM
EOF

# ── Disable services not needed in live environment ───────────────────────────
systemctl disable kdump.service  2>/dev/null || true
systemctl disable tuned.service  2>/dev/null || true
systemctl disable sssd.service   2>/dev/null || true

# ── Console boot message ──────────────────────────────────────────────────────
cat > /etc/motd <<'EOF'

  ╔══════════════════════════════════════════════════╗
  ║        Baremetal Validation Image                ║
  ║  Running hardware tests and LLDP discovery…      ║
  ║  Check /var/log/bm-validate.log for progress.    ║
  ╚══════════════════════════════════════════════════╝

EOF
%end

%post --nochroot --erroronfail
# Copy scripts into the chroot for the %post above
cp -r /tmp/bm-validate-scripts /mnt/sysimage/tmp/
cp -r /tmp/bm-validate-systemd /mnt/sysimage/tmp/
%end
