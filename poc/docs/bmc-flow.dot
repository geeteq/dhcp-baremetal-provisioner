/**
 * BMC Discovery — DHCP → NetBox Process Flow
 *
 * Covers:
 *   dhcp_hook2.sh              — DHCP hook entry point
 *   netbox-bmc-worker.sh       — Redis queue entry point
 *   scripts/lib/bmc-fsm.sh     — shared FSM library (all NetBox logic)
 *
 * Render:
 *   dot -Tsvg bmc-flow.dot -o bmc-flow.svg
 *   dot -Tpng bmc-flow.dot -o bmc-flow.png
 *
 * Node colours
 *   #cce5ff / #eef6ff  — entry / script headers
 *   #fffde7 / #f59e0b  — FSM dispatcher  (lib/bmc-fsm.sh)
 *   #ddc9f7 / #f5eeff  — NetBox API calls (lib/bmc-fsm.sh)
 *   #fff3cd            — decision diamonds
 *   #d4edda            — success / done
 *   #f8d7da            — error / skip paths
 *   #fff9c4            — warnings (non-fatal)
 *   #f5f5f5 / #9e9e9e  — stubbed future transitions (dashed)
 */

digraph bmc_discovery {

    rankdir  = TB
    graph [
        fontname      = "Helvetica,Arial,sans-serif"
        fontsize      = 12
        compound      = true
        nodesep       = 0.55
        ranksep       = 0.65
        bgcolor       = "white"
        label         = "BMC Discovery — DHCP → NetBox\ndhcp_hook2.sh  |  netbox-bmc-worker.sh  →  scripts/lib/bmc-fsm.sh"
        labelloc      = t
        labelfontsize = 16
    ]
    node [
        fontname  = "Helvetica,Arial,sans-serif"
        fontsize  = 10
        style     = "filled,rounded"
        shape     = box
        fillcolor = "#e8f4f8"
        color     = "#446688"
        margin    = "0.18,0.10"
    ]
    edge [
        fontname  = "Helvetica,Arial,sans-serif"
        fontsize  = 9
        color     = "#555555"
        arrowsize = 0.8
    ]

    /* ── shared terminals ────────────────────────────────── */
    exit_ok  [ label="Exit 0",  shape=oval, fillcolor="#d4edda", color="#28a745" ]
    exit_err [ label="Exit 1",  shape=oval, fillcolor="#f8d7da", color="#dc3545" ]
    done     [ label="Done",    shape=oval, fillcolor="#d4edda", color="#28a745" ]


    /* ═══════════════════════════════════════════════════════
     * A — dhcp_hook2.sh  (called by dhcpd on every commit)
     * ═══════════════════════════════════════════════════════ */
    subgraph cluster_hook {
        label     = "dhcp_hook2.sh"
        style     = filled
        fillcolor = "#eef6ff"
        color     = "#2255aa"
        fontsize  = 13
        fontcolor = "#2255aa"

        h_start [ label="dhcpd executes hook\n\$1=IP  \$2=MAC  \$3=hostname",
                  shape=oval, fillcolor="#cce5ff", color="#2255aa" ]

        h_valid [ label="IP and MAC\nnot empty?",
                  shape=diamond, fillcolor="#fff3cd", color="#856404" ]

        h_err   [ label="log_error: missing args",
                  fillcolor="#f8d7da", color="#721c24" ]

        h_norm  [ label="Normalize MAC\nlower-case · colon-separated" ]

        h_oui   [ label="is_bmc_mac()\nOUI in BMC_OUIS?",
                  shape=diamond, fillcolor="#fff3cd", color="#856404" ]

        h_skip  [ label="Not a BMC MAC\n— silent exit",
                  fillcolor="#f8d7da", color="#721c24" ]

        h_call  [ label="fsm_process_bmc_event()\ntrigger=dhcp_seen · mac · ip",
                  fillcolor="#fff9c4", color="#856404" ]
    }


    /* ═══════════════════════════════════════════════════════
     * B — netbox-bmc-worker.sh  (long-running daemon)
     * ═══════════════════════════════════════════════════════ */
    subgraph cluster_worker {
        label     = "netbox-bmc-worker.sh"
        style     = filled
        fillcolor = "#efffef"
        color     = "#1a6b1a"
        fontsize  = 13
        fontcolor = "#1a6b1a"

        w_start  [ label="Worker process starts\nlog config + banner",
                   shape=oval, fillcolor="#c3e6cb", color="#155724" ]

        w_ping   [ label="redis_cmd PING",
                   shape=diamond, fillcolor="#fff3cd", color="#856404" ]

        w_perr   [ label="log_error: cannot connect to Redis",
                   fillcolor="#f8d7da", color="#721c24" ]

        w_loop   [ label="Main loop",
                   shape=oval, fillcolor="#c3e6cb", color="#155724" ]

        w_brpop  [ label="BRPOP  queue  timeout=1 s",
                   shape=diamond, fillcolor="#fff3cd", color="#856404" ]

        w_rerr   [ label="log_error: BRPOP failed\nsleep 5 s · retry",
                   fillcolor="#f8d7da", color="#721c24" ]

        w_parse  [ label="Parse JSON event\nevent_type · mac_address · ip_address" ]

        w_valid  [ label="mac_address and\nip_address present?",
                   shape=diamond, fillcolor="#fff3cd", color="#856404" ]

        w_verr   [ label="log_error: missing fields",
                   fillcolor="#f8d7da", color="#721c24" ]

        w_call   [ label="fsm_process_bmc_event()\ntrigger=dhcp_seen · mac · ip",
                   fillcolor="#fff9c4", color="#856404" ]
    }


    /* ═══════════════════════════════════════════════════════
     * C — nb_find_device_by_bmc_mac()  [lib/bmc-fsm.sh]
     * ═══════════════════════════════════════════════════════ */
    subgraph cluster_find {
        label     = "nb_find_device_by_bmc_mac()  [lib/bmc-fsm.sh]"
        style     = filled
        fillcolor = "#f5eeff"
        color     = "#6625a8"
        fontsize  = 12
        fontcolor = "#6625a8"

        f_upper  [ label="Normalize MAC → UPPER:CASE" ]

        f_iface  [ label="GET /api/dcim/interfaces/\n?mac_address=MAC&name=bmc\ntimeout 20 s",
                   fillcolor="#ddc9f7", color="#6625a8" ]

        f_count  [ label="results.count == 0?",
                   shape=diamond, fillcolor="#fff3cd", color="#856404" ]

        f_none   [ label="log_warn: no device for this MAC",
                   fillcolor="#f8d7da", color="#721c24" ]

        f_dev    [ label="GET /api/dcim/devices/{id}/\ntimeout 20 s",
                   fillcolor="#ddc9f7", color="#6625a8" ]

        f_ret    [ label="Return\ndevice_id · device_name\ninterface_id · current_state" ]
    }


    /* ═══════════════════════════════════════════════════════
     * D — fsm_process_bmc_event()  [lib/bmc-fsm.sh]
     * ═══════════════════════════════════════════════════════ */
    subgraph cluster_fsm_proc {
        label     = "fsm_process_bmc_event()  [lib/bmc-fsm.sh]"
        style     = filled
        fillcolor = "#fffde7"
        color     = "#e6a817"
        fontsize  = 12
        fontcolor = "#7a5000"

        fp_find  [ label="call nb_find_device_by_bmc_mac(mac)" ]

        fp_found [ label="Device found\nin NetBox?",
                   shape=diamond, fillcolor="#fff3cd", color="#856404" ]

        fp_nodev [ label="log_error: device not found\nno action taken",
                   fillcolor="#f8d7da", color="#721c24" ]

        fp_jrnl  [ label="POST /api/extras/journal-entries/\nkind=success\n\"BMC discovered via DHCP — MAC / IP\"\ntimeout 20 s",
                   fillcolor="#ddc9f7", color="#6625a8" ]

        fp_scan  [ label="Scan FSM_TRANSITIONS[]\nfor trigger:from_state match" ]

        fp_match [ label="Match found?",
                   shape=diamond, fillcolor="#fff3cd", color="#856404" ]

        fp_nomatch [ label="log_warn: no transition\nPOST journal  kind=warning",
                     fillcolor="#fff9c4", color="#856404" ]
    }


    /* ═══════════════════════════════════════════════════════
     * E — _fsm_active_refresh()  [lib/bmc-fsm.sh]
     *     Transition: dhcp_seen · active → active
     * ═══════════════════════════════════════════════════════ */
    subgraph cluster_active {
        label     = "_fsm_active_refresh()  [active → active]\nlive device — BMC IP refresh only"
        style     = filled
        fillcolor = "#e8f5e9"
        color     = "#2e7d32"
        fontsize  = 11

        a_getip  [ label="GET /api/ipam/ip-addresses/\n?assigned_object_type=dcim.interface\n&assigned_object_id=IFACE_ID\ntimeout 20 s",
                   fillcolor="#ddc9f7", color="#6625a8" ]

        a_exist  [ label="IP record\nalready exists?",
                   shape=diamond, fillcolor="#fff3cd", color="#856404" ]

        a_patch  [ label="PATCH /api/ipam/ip-addresses/{id}/\naddress=IP/PREFIX · updated description\ntimeout 20 s",
                   fillcolor="#ddc9f7", color="#6625a8" ]

        a_post   [ label="POST /api/ipam/ip-addresses/\n(no record yet — fallback assign)\ntimeout 20 s",
                   fillcolor="#ddc9f7", color="#6625a8" ]

        a_jrnl   [ label="POST /api/extras/journal-entries/\nkind=info  \"IP assigned to interface bmc\"\ntimeout 20 s",
                   fillcolor="#ddc9f7", color="#6625a8" ]
    }


    /* ═══════════════════════════════════════════════════════
     * F — _fsm_offline_to_discovered()  [lib/bmc-fsm.sh]
     *     Transition: dhcp_seen · offline → discovered
     * ═══════════════════════════════════════════════════════ */
    subgraph cluster_offline {
        label     = "_fsm_offline_to_discovered()  [offline → discovered]\nnew device — full onboarding"
        style     = filled
        fillcolor = "#e3f2fd"
        color     = "#1565c0"
        fontsize  = 11

        o_patch  [ label="PATCH /api/dcim/devices/{id}/\nstatus = \"discovered\"\ntimeout 20 s",
                   fillcolor="#ddc9f7", color="#6625a8" ]

        o_jrnl1  [ label="POST /api/extras/journal-entries/\nkind=success  \"offline → discovered\"\ntimeout 20 s",
                   fillcolor="#ddc9f7", color="#6625a8" ]

        o_post   [ label="POST /api/ipam/ip-addresses/\naddress=IP/PREFIX · status=active\nassigned to bmc interface\ntimeout 20 s",
                   fillcolor="#ddc9f7", color="#6625a8" ]

        o_400    [ label="HTTP 400?\n(duplicate IP)",
                   shape=diamond, fillcolor="#fff3cd", color="#856404" ]

        o_warn   [ label="log_warn: IP may already exist — skip",
                   fillcolor="#fff9c4", color="#856404" ]

        o_jrnl2  [ label="POST /api/extras/journal-entries/\nkind=info  \"IP assigned to interface bmc\"\ntimeout 20 s",
                   fillcolor="#ddc9f7", color="#6625a8" ]
    }


    /* ═══════════════════════════════════════════════════════
     * G — _fsm_discovered_refresh()  [lib/bmc-fsm.sh]
     *     Transition: dhcp_seen · discovered → discovered
     * ═══════════════════════════════════════════════════════ */
    subgraph cluster_discovered {
        label     = "_fsm_discovered_refresh()  [discovered → discovered]\nalready seen — refresh IP"
        style     = filled
        fillcolor = "#e0f7fa"
        color     = "#00695c"
        fontsize  = 11

        d_post   [ label="POST /api/ipam/ip-addresses/\naddress=IP/PREFIX · status=active\nassigned to bmc interface\ntimeout 20 s",
                   fillcolor="#ddc9f7", color="#6625a8" ]

        d_400    [ label="HTTP 400?\n(duplicate IP)",
                   shape=diamond, fillcolor="#fff3cd", color="#856404" ]

        d_warn   [ label="log_warn: IP may already exist — skip",
                   fillcolor="#fff9c4", color="#856404" ]

        d_jrnl   [ label="POST /api/extras/journal-entries/\nkind=info  \"IP assigned to interface bmc\"\ntimeout 20 s",
                   fillcolor="#ddc9f7", color="#6625a8" ]
    }


    /* ═══════════════════════════════════════════════════════
     * H — Stubbed future transitions  [lib/bmc-fsm.sh]
     *     Uncomment rows in FSM_TRANSITIONS to activate
     * ═══════════════════════════════════════════════════════ */
    subgraph cluster_stubs {
        label     = "Future transitions — add function + uncomment FSM_TRANSITIONS row"
        style     = "filled,dashed"
        fillcolor = "#f5f5f5"
        color     = "#9e9e9e"
        fontsize  = 11
        fontcolor = "#9e9e9e"

        s_pxe    [ label="pxe_complete: discovered → staged\n_fsm_discovered_to_staged()",
                   style="filled,rounded,dashed", fillcolor="#f5f5f5", color="#9e9e9e", fontcolor="#9e9e9e" ]

        s_prov   [ label="provisioned: staged → ready\n_fsm_staged_to_ready()",
                   style="filled,rounded,dashed", fillcolor="#f5f5f5", color="#9e9e9e", fontcolor="#9e9e9e" ]

        s_deliv  [ label="delivered: ready → active\n_fsm_ready_to_active()",
                   style="filled,rounded,dashed", fillcolor="#f5f5f5", color="#9e9e9e", fontcolor="#9e9e9e" ]

        s_decom  [ label="decommission: active → decommissioned\n_fsm_active_to_decommissioned()",
                   style="filled,rounded,dashed", fillcolor="#f5f5f5", color="#9e9e9e", fontcolor="#9e9e9e" ]
    }


    /* ═══════════════════════════════════════════════════════
     * EDGES — dhcp_hook2.sh
     * ═══════════════════════════════════════════════════════ */
    h_start -> h_valid
    h_valid -> h_err   [ label="no"  ]
    h_valid -> h_norm  [ label="yes" ]
    h_err   -> exit_ok
    h_norm  -> h_oui
    h_oui   -> h_skip  [ label="no match" ]
    h_oui   -> h_call  [ label="match"    ]
    h_skip  -> exit_ok
    h_call  -> fp_find [ lhead=cluster_fsm_proc, label="  " ]


    /* ═══════════════════════════════════════════════════════
     * EDGES — netbox-bmc-worker.sh
     * ═══════════════════════════════════════════════════════ */
    w_start -> w_ping
    w_ping  -> w_perr  [ label="fail" ]
    w_ping  -> w_loop  [ label="ok"   ]
    w_perr  -> exit_err
    w_loop  -> w_brpop
    w_brpop -> w_rerr  [ label="error"   ]
    w_brpop -> w_loop  [ label="timeout" ]
    w_brpop -> w_parse [ label="event"   ]
    w_rerr  -> w_loop
    w_parse -> w_valid
    w_valid -> w_verr  [ label="no"  ]
    w_valid -> w_call  [ label="yes" ]
    w_verr  -> w_loop
    w_call  -> fp_find [ lhead=cluster_fsm_proc, label="  " ]


    /* ═══════════════════════════════════════════════════════
     * EDGES — fsm_process_bmc_event() internal
     * ═══════════════════════════════════════════════════════ */
    fp_find   -> f_upper   [ lhead=cluster_find, label="call" ]
    f_ret     -> fp_found  [ ltail=cluster_find, label="return JSON" ]
    f_none    -> fp_found  [ ltail=cluster_find, label="return null" ]

    fp_found  -> fp_nodev  [ label="no"  ]
    fp_found  -> fp_jrnl   [ label="yes" ]
    fp_nodev  -> exit_ok
    fp_jrnl   -> fp_scan
    fp_scan   -> fp_match
    fp_match  -> fp_nomatch [ label="no match" ]
    fp_nomatch -> done


    /* ═══════════════════════════════════════════════════════
     * EDGES — FSM dispatch to action functions
     * ═══════════════════════════════════════════════════════ */
    fp_match -> a_getip [ label="dhcp_seen:active",     lhead=cluster_active     ]
    fp_match -> o_patch [ label="dhcp_seen:offline",    lhead=cluster_offline    ]
    fp_match -> d_post  [ label="dhcp_seen:discovered", lhead=cluster_discovered ]

    /* Stubbed future transitions (dashed) */
    fp_match -> s_pxe   [ label="pxe_complete:discovered", lhead=cluster_stubs,
                          style=dashed, color="#9e9e9e", fontcolor="#9e9e9e" ]


    /* ═══════════════════════════════════════════════════════
     * EDGES — _fsm_active_refresh()
     * ═══════════════════════════════════════════════════════ */
    a_getip -> a_exist
    a_exist -> a_patch [ label="yes" ]
    a_exist -> a_post  [ label="no"  ]
    a_patch -> a_jrnl
    a_post  -> a_jrnl
    a_jrnl  -> done    [ ltail=cluster_active ]


    /* ═══════════════════════════════════════════════════════
     * EDGES — _fsm_offline_to_discovered()
     * ═══════════════════════════════════════════════════════ */
    o_patch -> o_jrnl1
    o_jrnl1 -> o_post
    o_post  -> o_400
    o_400   -> o_warn  [ label="yes" ]
    o_400   -> o_jrnl2 [ label="no"  ]
    o_warn  -> o_jrnl2
    o_jrnl2 -> done    [ ltail=cluster_offline ]


    /* ═══════════════════════════════════════════════════════
     * EDGES — _fsm_discovered_refresh()
     * ═══════════════════════════════════════════════════════ */
    d_post -> d_400
    d_400  -> d_warn  [ label="yes" ]
    d_400  -> d_jrnl  [ label="no"  ]
    d_warn -> d_jrnl
    d_jrnl -> done    [ ltail=cluster_discovered ]


    /* ═══════════════════════════════════════════════════════
     * Worker loops back after each processed event
     * ═══════════════════════════════════════════════════════ */
    done -> w_loop [
        style      = dashed
        color      = "#888888"
        label      = "worker: next event"
        constraint = false
    ]
}
